<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Notes App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, textarea { display: block; margin: 10px 0; padding: 8px; width: 300px; }
    button { margin: 5px 0; padding: 8px 12px; cursor: pointer; }
    .note { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
    h1, h2 { color: #333; }
    form { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; max-width: 400px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, textarea { display: block; margin-bottom: 15px; padding: 10px; width: calc(100% - 22px); border: 1px solid #ccc; border-radius: 4px; }
    button { margin: 5px 0; padding: 10px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
    button:hover { background-color: #0056b3; }
    #logout-btn { background-color: #6c757d; }
    #logout-btn:hover { background-color: #5a6268; }
    .note { background: #fff; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .note h3 { margin-top: 0; }
    .note button { background-color: #dc3545; margin-right: 5px; }
    .note button:hover { background-color: #c82333; }
    .note button.update-btn { background-color: #28a745; }
    .note button.update-btn:hover { background-color: #218838; }
    #message-area { margin: 15px 0; padding: 10px; border-radius: 4px; display: none; }
    .message-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <h1>Notes App</h1>
  <div id="message-area"></div>
    <form id="register-form">
      <h2>Register</h2>
      <label for="reg-username-input">Username</label>
      <input id="reg-username-input" placeholder="Username" required>
      <label for="reg-email-input">Email</label>
      <input id="reg-email-input" type="email" placeholder="Email" required>
      <label for="reg-password-input">Password</label>
      <input id="reg-password-input" type="password" placeholder="Password" required>
      <button type="submit">Register</button>
    </form>

    <form id="login-form">
      <h2>Login</h2>
      <label for="login-email-input">Email</label>
      <input id="login-email-input" type="email" placeholder="Email" required>
      <label for="login-password-input">Password</label>
      <input id="login-password-input" type="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
  </div>

  <h2>Create Note</h2>
  <input id="note-title" placeholder="Title">
  <textarea id="note-content" placeholder="Content"></textarea>
  <button onclick="createNote()">Create</button>
  <div id="notes-section" style="display: none;">
    <button id="logout-btn">Logout</button>
    <form id="create-note-form">
      <h2>Create Note</h2>
      <label for="note-title-input">Title</label>
      <input id="note-title-input" placeholder="Title" required>
      <label for="note-content-input">Content</label>
      <textarea id="note-content-input" placeholder="Content" required></textarea>
      <button type="submit">Create</button>
    </form>

  <h2>My Notes</h2>
  <div id="notes"></div>
    <h2>My Notes</h2>
    <div id="notes-container"></div>
  </div>

  <script>
    const API_URL = "http://localhost:5000/api";
    let token = localStorage.getItem("token") || "";
    let token = localStorage.getItem("token");

    async function register() {
      const username = document.getElementById("reg-username").value;
      const email = document.getElementById("reg-email").value;
      const password = document.getElementById("reg-password").value;
      await fetch(`${API_URL}/auth/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, email, password })
      });
      alert("Registered! Now login.");
    }
    const registerForm = document.getElementById("register-form");
    const loginForm = document.getElementById("login-form");
    const createNoteForm = document.getElementById("create-note-form");
    const logoutBtn = document.getElementById("logout-btn");
    const authSection = document.getElementById("auth-section");
    const notesSection = document.getElementById("notes-section");
    const messageArea = document.getElementById("message-area");

    async function login() {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      const res = await fetch(`${API_URL}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      token = data.token;
      localStorage.setItem("token", token);
      alert("Logged in!");
      getNotes();
    }
    // --- Helper Functions ---
    const showMessage = (message, isError = false) => {
      messageArea.textContent = message;
      messageArea.className = isError ? 'message-error' : 'message-success';
      messageArea.style.display = 'block';
      setTimeout(() => { messageArea.style.display = 'none'; }, 4000);
    };

    async function createNote() {
      const title = document.getElementById("note-title").value;
      const content = document.getElementById("note-content").value;
      await fetch(`${API_URL}/notes`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ title, content })
      });
      getNotes();
    }
    const updateUI = () => {
      token = localStorage.getItem("token");
      if (token) {
        authSection.style.display = 'none';
        notesSection.style.display = 'block';
        getNotes();
      } else {
        authSection.style.display = 'block';
        notesSection.style.display = 'none';
        document.getElementById("notes-container").innerHTML = '';
      }
    };

    async function getNotes() {
      const res = await fetch(`${API_URL}/notes`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const notes = await res.json();
      const notesDiv = document.getElementById("notes");
      notesDiv.innerHTML = "";
      notes.forEach(note => {
        const div = document.createElement("div");
        div.className = "note";
        div.innerHTML = `
          <h3>${note.title}</h3>
          <p>${note.content}</p>
          <button onclick="deleteNote('${note._id}')">Delete</button>
          <button onclick="updateNote('${note._id}')">Update</button>
        `;
        notesDiv.appendChild(div);
      });
    }
    const apiFetch = async (endpoint, options = {}) => {
      const headers = { "Content-Type": "application/json", ...options.headers };
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

    async function deleteNote(id) {
      await fetch(`${API_URL}/notes/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });
      getNotes();
    }
      const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });

    async function updateNote(id) {
      const newTitle = prompt("Enter new title:");
      const newContent = prompt("Enter new content:");
      await fetch(`${API_URL}/notes/${id}`, {
        method: "PUT",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ title: newTitle, content: newContent })
      });
      getNotes();
    }
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({ message: 'An unknown network error occurred.' }));
        throw new Error(errorData.message || `HTTP error! Status: ${res.status}`);
      }

    if (token) getNotes();
      return res.status === 204 ? null : res.json();
    };

    // --- Event Listeners ---
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("reg-username-input").value;
      const email = document.getElementById("reg-email-input").value;
      const password = document.getElementById("reg-password-input").value;
      try {
        await apiFetch("/auth/register", {
          method: "POST",
          body: JSON.stringify({ username, email, password })
        });
        showMessage("Registered successfully! Please log in.");
        registerForm.reset();
      } catch (error) {
        showMessage(error.message, true);
      }
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email-input").value;
      const password = document.getElementById("login-password-input").value;
      try {
        const data = await apiFetch("/auth/login", {
          method: "POST",
          body: JSON.stringify({ email, password })
        });
        if (data.token) {
          token = data.token;
          localStorage.setItem("token", data.token);
          showMessage("Logged in successfully!");
          loginForm.reset();
          updateUI();
        } else {
          throw new Error("Login failed: No token was received from the server.");
        }
      } catch (error) {
        showMessage(error.message, true);
      }
    });

    createNoteForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("note-title-input").value;
      const content = document.getElementById("note-content-input").value;
      try {
        await apiFetch("/notes", {
          method: "POST",
          body: JSON.stringify({ title, content })
        });
        createNoteForm.reset();
        showMessage("Note created!");
        getNotes();
      } catch (error) {
        showMessage(error.message, true);
      }
    });

    const getNotes = async () => {
      try {
        const notes = await apiFetch("/notes");
        const notesContainer = document.getElementById("notes-container");
        notesContainer.innerHTML = "";
        if (notes.length === 0) {
          notesContainer.innerHTML = "<p>You don't have any notes yet.</p>";
        }
        notes.forEach(note => {
          const div = document.createElement("div");
          div.className = "note";
          div.innerHTML = `
            <h3>${escapeHTML(note.title)}</h3>
            <p>${escapeHTML(note.content)}</p>
            <button onclick="deleteNote('${note._id}')">Delete</button>
            <button class="update-btn" onclick="updateNote('${note._id}', '${escapeHTML(note.title)}', '${escapeHTML(note.content)}')">Update</button>
          `;
          notesContainer.appendChild(div);
        });
      } catch (error) {
        showMessage(error.message, true);
      }
    };

    const deleteNote = async (id) => {
      if (!confirm("Are you sure you want to delete this note?")) return;
      try {
        await apiFetch(`/notes/${id}`, { method: "DELETE" });
        getNotes();
      } catch (error) {
        showMessage(error.message, true);
      }
    };

    const updateNote = async (id, currentTitle, currentContent) => {
      const newTitle = prompt("Enter new title:", currentTitle);
      if (newTitle === null) return; // User cancelled
      const newContent = prompt("Enter new content:", currentContent);
      if (newContent === null) return; // User cancelled

      try {
        await apiFetch(`/notes/${id}`, {
          method: "PUT",
          body: JSON.stringify({ title: newTitle, content: newContent })
        });
        getNotes();
      } catch (error) {
        showMessage(error.message, true);
      }
    };

    // Make functions available globally on the window object for onclick attributes
    window.deleteNote = deleteNote;
    window.updateNote = updateNote;

    const escapeHTML = str => str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[match]);


    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      token = null;
      showMessage("You have been logged out.");
      updateUI();
    });

    // --- Initial Load ---
    document.addEventListener("DOMContentLoaded", updateUI);
  </script>
</body>
</html>
